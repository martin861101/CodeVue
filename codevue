#!/usr/codevue/bin/env python3

from textual.app import App, ComposeResult
from textual.widgets import Header, Footer, Input, RichLog, Label
from textual.binding import Binding
from rich.markdown import Markdown
import asyncio
import os
from pathlib import Path
from core.agent import NeuroAgent
from core.logger import sys_log
from core.providers.gemini import GeminiProvider
from core.providers.ollama import OllamaProvider

class NeuroTermApp(App):
    CSS = """
    Screen { background: #000000; }
    RichLog { border: solid #00ff00; background: #000000; color: #00ff00; height: 1fr; }
    Input { dock: bottom; border: solid #00ffff; background: #000000; color: #00ffff; }
    .status { color: #ff00ff; text-align: center; height: 1; display: none; background: #000000; border: solid #ff00ff; }
    .status.thinking { display: block; }
    """

    BINDINGS = [
        Binding("ctrl+c", "quit", "Quit"),
        Binding("ctrl+l", "clear", "Clear"),
    ]

    def __init__(self):
        super().__init__()
        api_key = os.getenv("GEMINI_API_KEY", "")
        self.agent = NeuroAgent("gemini", api_key=api_key)
        self.debug_mode = False
        self.thinking_task = None

    def compose(self) -> ComposeResult:
        yield Header()
        yield RichLog(id="chat", markup=True)
        yield Label("", id="status", classes="status")
        yield Input(placeholder="Enter message or /help...")
        yield Footer()

    async def on_mount(self):
        self.log_widget = self.query_one(RichLog)
        self.input = self.query_one(Input)
        self.status_label = self.query_one("#status")
        self.log_widget.write(Markdown("# üñ•Ô∏è  CodeVue-3.0 - Agentic System Online"))

    def start_thinking(self):
        self.status_label.add_class("thinking")
        self.status_label.update("ü§ñ AGENT WORKING...")

    def stop_thinking(self):
        self.status_label.remove_class("thinking")
        self.status_label.update("")

    async def on_input_submitted(self, event: Input.Submitted):
        msg = event.value.strip()
        if not msg: return
        self.input.value = ""

        if msg.startswith("/"):
            await self.handle_command(msg)
            return

        self.log_widget.write(Markdown(f"**You:** {msg}"))
        self.start_thinking()
        
        if self.debug_mode:
             self.log_widget.write(Markdown("`[DEBUG] Request sent to Agent Stream...`"))

        try:
            response = ""
            async for token in self.agent.stream(msg):
                response += token
            self.log_widget.write(Markdown(f"**Neuroterm:** {response}"))
        except Exception as e:
            self.log_widget.write(f"‚ùå Error: {str(e)}")
        finally:
            self.stop_thinking()

    async def handle_command(self, cmd: str):
        parts = cmd.split(maxsplit=1)
        base = parts[0].lower()
        arg = parts[1] if len(parts) > 1 else ""

        try:
            if base == "/help":
                self.log_widget.write(Markdown("""
**COMMANDS:**
- `/test <file>`: Run autonomous fix loop
- `/log`: View system logs
- `/debug`: Toggle debug mode
- `/autofix <file>`: Simple one-shot fix
- `/provider <name>`: Switch AI
- `/allow write`: Enable editing
"""))
            
            elif base == "/test":
                if not arg:
                    self.log_widget.write("Usage: /test <file>")
                    return
                self.start_thinking()
                async for update in self.agent.autonomous_fix(arg):
                    self.log_widget.write(Markdown(update))
                self.stop_thinking()

            elif base == "/log":
                logs = sys_log.get_recent_logs(15)
                self.log_widget.write(Markdown("**üìù Recent System Logs:**"))
                self.log_widget.write("\n".join(logs))

            elif base == "/debug":
                self.debug_mode = not self.debug_mode
                self.log_widget.write(f"üêû Debug Mode: {self.debug_mode}")

            elif base == "/allow":
                if arg == "write":
                    self.agent.files.write_allowed = True
                    self.log_widget.write("‚úÖ Write Access ENABLED")

            elif base == "/provider":
                self.agent.provider_name = arg
                self.agent._load_provider()
                self.log_widget.write(f"‚úÖ Switched to {arg}")

            elif base == "/autofix":
                # Legacy simple fix
                await self.legacy_autofix(arg)
                
            else:
                self.log_widget.write(f"‚ùå Unknown command: {base}")

        except Exception as e:
            self.log_widget.write(f"‚ùå Command Error: {e}")

    async def legacy_autofix(self, arg):
        # Quick one-shot fix wrapper
        if not arg: return
        self.start_thinking()
        prompt = f"Fix this code:\n{self.agent.files.read_file(arg)}"
        resp = ""
        async for token in self.agent.stream(prompt): resp += token
        self.log_widget.write(Markdown("**Fix Suggested:**\n" + resp))
        self.stop_thinking()

if __name__ == "__main__":
    NeuroTermApp().run()
